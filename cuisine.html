<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuisine - Le Petit Gourmet</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <header><div class="banner"><h1>üë®‚Äçüç≥ √âcran Cuisine</h1></div></header>

    <div class="kitchen-container">
        <div class="refresh-bar">
            <button class="refresh-btn" onclick="loadOrders()"><i class="fas fa-sync"></i> Actualiser</button>
        </div>
        <div id="orders-list">Chargement...</div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Mets ici tes liens (les m√™mes que d'habitude)
        const CSV_COMMANDES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7lTNMQNNmgQrlsBbtD0lsq4emQqNVoeVUxpgG2WFLOgopD_z6u5fQ6S31krFBuTqiwFfUX6nU6O7g/pub?gid=1409508146&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyt2vbix3M94n_thVPXzmYdFirabX0HO7BKNvkE6LDUm6CQVGQKzLuZQ6bgkQS28sc6eQ/exec';

        document.addEventListener('DOMContentLoaded', loadOrders);

        function loadOrders() {
            document.getElementById('orders-list').innerHTML = '<p style="text-align:center">Actualisation...</p>';
            // On ajoute l'heure pour forcer le navigateur √† ne pas utiliser le cache
            fetch(CSV_COMMANDES_URL + '&t=' + Date.now()) 
                .then(res => res.text())
                .then(text => {
                    const orders = parseCSV(text);
                    renderOrders(orders);
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('orders-list').innerHTML = '<p style="text-align:center; color:red">Erreur de chargement</p>';
                });
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            container.innerHTML = '';
            
            // --- LE FILTRE MAGIQUE ---
            // On garde la commande SI le statut n'est PAS "Servi"
            const activeOrders = orders.filter(o => {
                // On nettoie le texte (enl√®ve les espaces autour) pour √™tre s√ªr
                const statut = (o.Statut || "").trim();
                return statut !== "Servi";
            });

            // On inverse pour voir les nouvelles commandes en haut
            activeOrders.reverse().forEach(order => {
                // S√©curit√© : on ignore les lignes vides sans ID
                if(!order.ID_Commande) return;

                const div = document.createElement('div');
                div.className = 'order-card';
                div.innerHTML = `
                    <div class="order-header">
                        <span>${order.ID_Commande}</span>
                        <span>Table ${order.Table}</span>
                    </div>
                    <div class="order-details">
                        ${order.Details}
                    </div>
                    <div class="order-meta">
                        <span>üë§ ${order.Client}</span>
                        ${order.Commentaire ? `<span style="color:#d35400">‚ö†Ô∏è ${order.Commentaire}</span>` : ''}
                    </div>
                    <div style="margin-top:15px; overflow:hidden;">
                        <button class="btn-done" onclick="markAsServed('${order.ID_Commande}', this)">
                            <i class="fas fa-check"></i> Termin√© / Servir
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            if(activeOrders.length === 0) {
                container.innerHTML = '<p style="text-align:center; margin-top:20px; color:#888;">Aucune commande en attente ! üë®‚Äçüç≥</p>';
            }
        }

        function markAsServed(id, btnElement) {
            // 1. Changement visuel imm√©diat (Feedback utilisateur)
            btnElement.innerText = "En cours...";
            btnElement.disabled = true;

            // 2. Envoi de la requ√™te √† Google Sheets
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'serve', orderId: id })
            }).then(() => {
                // 3. Animation de disparition
                const card = btnElement.closest('.order-card');
                card.style.transition = "all 0.5s ease";
                card.style.opacity = "0";
                card.style.transform = "translateX(50px)";
                
                // 4. Suppression du DOM apr√®s l'animation
                setTimeout(() => {
                    card.remove();
                    // V√©rifier s'il reste des commandes pour afficher le message "Aucune commande"
                    const container = document.getElementById('orders-list');
                    if(container.children.length === 0) {
                        container.innerHTML = '<p style="text-align:center; margin-top:20px; color:#888;">Aucune commande en attente ! üë®‚Äçüç≥</p>';
                    }
                }, 500);
            }).catch(err => {
                alert("Erreur de connexion internet");
                btnElement.disabled = false;
                btnElement.innerText = "R√©essayer";
            });
        }

        // Parseur CSV Robuste
        function parseCSV(str) {
            const lines = str.split('\n').filter(l => l.trim() !== '');
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                // Cette expression r√©guli√®re g√®re correctement les virgules DANS les guillemets
                const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
                const cleanValues = values.map(val => val.replace(/^"|"$/g, '').trim());
                
                let obj = {};
                headers.forEach((h, i) => obj[h] = cleanValues[i] || '');
                return obj;
            });
        }
    </script>
</body>
</html>
