<<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuisine - √âcran Chef</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* --- STYLE SP√âCIFIQUE CUISINE (Int√©gr√© ici pour ne pas d√©pendre du menu) --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #2c3e50; /* Fond sombre reposant pour les yeux */
            color: #ecf0f1;
            margin: 0; padding: 20px;
        }

        /* En-t√™te */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #7f8c8d; padding-bottom: 15px; margin-bottom: 20px;
        }
        h1 { margin: 0; font-size: 1.8rem; }
        
        /* Bouton Actualiser */
        .refresh-btn {
            background: #34495e; color: white; border: 1px solid #7f8c8d;
            padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; gap: 8px;
        }
        .refresh-btn:hover { background: #46637f; }

        /* Grille des tickets */
        #orders-list {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Cartes adaptatives */
            gap: 15px;
        }

        /* Carte de commande (Ticket) */
        .order-card {
            background: #ecf0f1; color: #2c3e50;
            border-radius: 8px; padding: 15px;
            border-left: 10px solid #e74c3c; /* Bande rouge √† gauche */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            display: flex; flex-direction: column;
        }

        .order-header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 2px dashed #bdc3c7; padding-bottom: 10px; margin-bottom: 10px;
            font-weight: bold; font-size: 1.1em;
        }

        .order-details { 
            font-size: 1.15em; line-height: 1.5; margin-bottom: 15px; flex-grow: 1; 
            white-space: pre-wrap; /* Garde les retours √† la ligne */
        }

        .order-meta { font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px; }

        /* Note (Commentaire client) */
        .order-note {
            background: #f1c40f; color: #2c3e50;
            padding: 8px; border-radius: 4px; margin-bottom: 10px;
            font-weight: bold; display: flex; align-items: center; gap: 8px;
            border: 1px solid #f39c12;
        }

        /* Bouton Termin√© */
        .btn-done {
            background: #27ae60; color: white; border: none;
            padding: 12px; width: 100%; border-radius: 5px;
            font-size: 1.1em; font-weight: bold; cursor: pointer;
            margin-top: auto; /* Pousse le bouton en bas */
            display: flex; justify-content: center; align-items: center; gap: 10px;
        }
        .btn-done:hover { background: #2ecc71; }
        .btn-done:disabled { background: #95a5a6; cursor: not-allowed; }

        /* Overlay de d√©marrage (Obligatoire pour le son) */
        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center;
        }
        .btn-big {
            padding: 20px 40px; font-size: 1.5em; background: #e67e22;
            border: none; color: white; border-radius: 10px; cursor: pointer; margin-top: 20px;
            font-weight: bold;
        }

        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="start-overlay">
        <i class="fas fa-utensils" style="font-size: 4em; margin-bottom: 20px;"></i>
        <h1>Pr√™t pour le service ?</h1>
        <p>Touchez pour activer le Son et l'Anti-Veille</p>
        <button class="btn-big" onclick="startService()">
            <i class="fas fa-play"></i> D√âMARRER
        </button>
    </div>

    <div class="header">
        <h1>üë®‚Äçüç≥ √âcran Cuisine</h1>
        <button class="refresh-btn" onclick="loadOrders()">
            <i class="fas fa-sync"></i> Actualiser <span id="timer">(15s)</span>
        </button>
    </div>

    <div id="orders-list">
        <p style="color:#bdc3c7; text-align:center; grid-column: 1/-1;">Chargement...</p>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <video id="nosleep-video" playsinline loop muted style="width:1px;height:1px;opacity:0;position:absolute;">
        <source src="https://raw.githubusercontent.com/richtr/NoSleep.js/master/src/1sec-black.mp4" type="video/mp4">
    </video>

    <script>
        // --- CONFIGURATION ---
        const CSV_COMMANDES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7lTNMQNNmgQrlsBbtD0lsq4emQqNVoeVUxpgG2WFLOgopD_z6u5fQ6S31krFBuTqiwFfUX6nU6O7g/pub?gid=1409508146&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyt2vbix3M94n_thVPXzmYdFirabX0HO7BKNvkE6LDUm6CQVGQKzLuZQ6bgkQS28sc6eQ/exec';

        let knownOrderIds = new Set();
        let soundEnabled = false;

        function startService() {
            document.getElementById('start-overlay').style.display = 'none';
            soundEnabled = true;
            // D√©blocage Audio/Vid√©o
            const audio = document.getElementById('alert-sound');
            audio.play().then(() => audio.pause()).catch(() => {});
            const video = document.getElementById('nosleep-video');
            video.play().catch(() => {});
            
            loadOrders();
            setInterval(loadOrders, 15000);
            startTimer();
        }

        function loadOrders() {
            const icon = document.querySelector('.refresh-btn i');
            if(icon) icon.classList.add('fa-spin');

            fetch(CSV_COMMANDES_URL + '&t=' + Date.now()) 
                .then(res => res.text())
                .then(text => {
                    const orders = parseCSV(text);
                    renderOrders(orders);
                    if(icon) icon.classList.remove('fa-spin');
                    timeLeft = 15;
                })
                .catch(err => {
                    console.error("Erreur", err);
                    if(icon) icon.classList.remove('fa-spin');
                });
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            const localFinished = JSON.parse(localStorage.getItem('finished_orders') || '[]');

            const activeOrders = orders.filter(o => {
                const statut = (o.Statut || "").toLowerCase().trim();
                const id = o.ID_Commande;
                if (!id) return false;
                if (statut.includes("servi")) return false;
                if (localFinished.includes(id)) return false;
                return true;
            });

            // Son
            let hasNew = false;
            activeOrders.forEach(o => {
                if (!knownOrderIds.has(o.ID_Commande)) {
                    hasNew = true;
                    knownOrderIds.add(o.ID_Commande);
                }
            });
            if (hasNew && soundEnabled) {
                const audio = document.getElementById('alert-sound');
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }

            container.innerHTML = '';
            if(activeOrders.length === 0) {
                container.innerHTML = '<p style="color:#bdc3c7; text-align:center; grid-column: 1/-1; margin-top:50px; font-size:1.2em;"><i class="fas fa-check-circle" style="font-size:2em; margin-bottom:10px;"></i><br>Aucune commande en attente.</p>';
                return;
            }

            activeOrders.reverse().forEach(order => {
                const div = document.createElement('div');
                div.className = 'order-card';
                div.innerHTML = `
                    <div class="order-header">
                        <span>#${order.ID_Commande.replace('#CMD-', '')}</span>
                        <span style="background:#fff; padding:2px 8px; border-radius:4px; font-size:0.9em;">Table ${order.Table}</span>
                    </div>
                    <div class="order-details">${order.Details}</div>
                    <div class="order-meta">
                        üë§ ${order.Client} | üí∞ ${order.Total}
                    </div>
                    ${order.Commentaire ? `<div class="order-note"><i class="fas fa-exclamation-triangle"></i> ${order.Commentaire}</div>` : ''}
                    <button class="btn-done" onclick="markAsServed('${order.ID_Commande}', this)">
                        <i class="fas fa-check"></i> TERMIN√â / SERVIR
                    </button>
                `;
                container.appendChild(div);
            });
        }

        function markAsServed(id, btn) {
            btn.innerText = "Traitement...";
            btn.disabled = true;

            let localFinished = JSON.parse(localStorage.getItem('finished_orders') || '[]');
            if(!localFinished.includes(id)) {
                localFinished.push(id);
                localStorage.setItem('finished_orders', JSON.stringify(localFinished));
            }

            fetch(APPS_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'serve', orderId: id })
            });

            const card = btn.closest('.order-card');
            card.style.opacity = "0";
            card.style.transform = "translateX(50px)";
            setTimeout(() => {
                card.remove();
                if(document.getElementById('orders-list').children.length === 0) {
                    renderOrders([]);
                }
            }, 300);
        }

        let timeLeft = 15;
        function startTimer() {
            setInterval(() => {
                timeLeft--;
                const t = document.getElementById('timer');
                if(t) t.innerText = `(${timeLeft}s)`;
                if(timeLeft <= 0) timeLeft = 15;
            }, 1000);
        }

        function parseCSV(str) {
            const lines = str.split('\n').filter(l => l.trim() !== '');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const cleanValues = values.map(val => val.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                let obj = {};
                headers.forEach((h, i) => obj[h] = cleanValues[i] || '');
                return obj;
            });
        }
    </script>
</body>
</html>
