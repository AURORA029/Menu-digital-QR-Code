<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cuisine - Le Petit Gourmet</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Overlay pour forcer l'interaction au d√©but (Son + √âcran) */
        #start-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(44, 62, 80, 0.95); display:flex; justify-content:center; align-items:center; z-index:9999; flex-direction: column; color: white; }
        .btn-start-service { padding: 20px 40px; font-size: 1.5em; background: #27ae60; border:none; color:white; border-radius:10px; cursor:pointer; margin-top: 20px; transition: transform 0.2s; }
        .btn-start-service:hover { transform: scale(1.05); }
    </style>
</head>
<body>

    <div id="start-overlay">
        <i class="fas fa-utensils" style="font-size: 4em; margin-bottom: 20px;"></i>
        <h1>Pr√™t pour le service ?</h1>
        <p>Cliquez pour activer le Son et l'Anti-Veille</p>
        <button class="btn-start-service" onclick="startService()">
            <i class="fas fa-play"></i> D√âMARRER
        </button>
    </div>

    <header><div class="banner"><h1>üë®‚Äçüç≥ √âcran Cuisine</h1></div></header>

    <div class="kitchen-container">
        <div class="refresh-bar">
            <button class="refresh-btn" onclick="loadOrders()">
                <i class="fas fa-sync"></i> Actualiser <span id="timer" style="font-size:0.8em; opacity:0.7">(15s)</span>
            </button>
        </div>
        <div id="orders-list">En attente de commandes...</div>
    </div>

    <audio id="alert-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>
    <video id="nosleep-video" playsinline loop muted style="width:1px;height:1px;opacity:0;">
        <source src="https://raw.githubusercontent.com/richtr/NoSleep.js/master/src/1sec-black.mp4" type="video/mp4">
    </video>

    <script>
        // --- TES LIENS ---
        const CSV_COMMANDES_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS7lTNMQNNmgQrlsBbtD0lsq4emQqNVoeVUxpgG2WFLOgopD_z6u5fQ6S31krFBuTqiwFfUX6nU6O7g/pub?gid=1409508146&single=true&output=csv';
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyt2vbix3M94n_thVPXzmYdFirabX0HO7BKNvkE6LDUm6CQVGQKzLuZQ6bgkQS28sc6eQ/exec';

        let knownOrderIds = new Set(); // Pour savoir si c'est une nouvelle commande (Son)
        let soundEnabled = false;

        // --- FONCTION DE D√âMARRAGE (SON + NO SLEEP) ---
        function startService() {
            document.getElementById('start-overlay').style.display = 'none';
            soundEnabled = true;
            
            // 1. D√©bloquer le son (hack navigateur)
            const audio = document.getElementById('alert-sound');
            audio.play().then(() => audio.pause()).catch(() => {});

            // 2. Emp√™cher la veille (hack vid√©o)
            const video = document.getElementById('nosleep-video');
            video.play().catch(() => {});

            // 3. Lancer la boucle
            loadOrders();
            setInterval(loadOrders, 15000);
            startTimer();
        }

        function loadOrders() {
            const btnIcon = document.querySelector('.refresh-btn i');
            if(btnIcon) btnIcon.classList.add('fa-spin');

            fetch(CSV_COMMANDES_URL + '&t=' + Date.now()) 
                .then(res => res.text())
                .then(text => {
                    const orders = parseCSV(text);
                    renderOrders(orders);
                    if(btnIcon) btnIcon.classList.remove('fa-spin');
                    timeLeft = 15;
                })
                .catch(err => {
                    console.error(err);
                    if(btnIcon) btnIcon.classList.remove('fa-spin');
                });
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');
            
            // On r√©cup√®re ce qu'on a d√©j√† servi dans la m√©moire du t√©l√©phone
            const localFinished = JSON.parse(localStorage.getItem('finished_orders') || '[]');

            // Filtre : On garde seulement ce qui n'est PAS servi ET pas dans la m√©moire locale
            const activeOrders = orders.filter(o => {
                const statut = (o.Statut || "").toLowerCase().trim();
                const id = o.ID_Commande;
                if (!id) return false;
                if (statut.includes("servi")) return false;
                if (localFinished.includes(id)) return false;
                return true;
            });

            // --- LOGIQUE SONORE ---
            // Si on trouve un ID dans activeOrders qu'on ne connaissait pas avant -> SON
            let hasNew = false;
            activeOrders.forEach(o => {
                if (!knownOrderIds.has(o.ID_Commande)) {
                    hasNew = true;
                    knownOrderIds.add(o.ID_Commande);
                }
            });

            if (hasNew && soundEnabled) {
                const audio = document.getElementById('alert-sound');
                audio.currentTime = 0;
                audio.play().catch(e => console.log("Son bloqu√©"));
            }
            // ----------------------

            // Rendu Visuel
            container.innerHTML = '';
            
            if(activeOrders.length === 0) {
                container.innerHTML = '<p style="text-align:center; margin-top:50px; color:#888; font-size:1.2em;"><i class="fas fa-mug-hot"></i><br>Tout est servi !</p>';
                return;
            }

            activeOrders.reverse().forEach(order => {
                const div = document.createElement('div');
                div.className = 'order-card';
                // Animation d'arriv√©e
                div.style.animation = "slideIn 0.5s ease-out";
                
                div.innerHTML = `
                    <div class="order-header">
                        <span>${order.ID_Commande}</span>
                        <span>Table ${order.Table}</span>
                    </div>
                    <div class="order-details">
                        ${order.Details}
                    </div>
                    <div class="order-meta">
                        <span>üë§ ${order.Client}</span>
                        <span>üí∞ ${order.Total}</span>
                    </div>
                    
                    ${order.Commentaire ? `
                        <div style="background-color:#fff3cd; color:#856404; padding:8px; border-radius:5px; margin-top:10px; font-weight:bold; white-space: pre-wrap; border-left: 4px solid #ffeeba;">
                            <i class="fas fa-exclamation-circle"></i> ${order.Commentaire}
                        </div>
                    ` : ''}

                    <div style="margin-top:15px; overflow:hidden;">
                        <button class="btn-done" onclick="markAsServed('${order.ID_Commande}', this)">
                            <i class="fas fa-check"></i> Termin√© / Servir
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function markAsServed(id, btnElement) {
            btnElement.innerText = "Traitement...";
            btnElement.disabled = true;

            // 1. Sauvegarde locale imm√©diate (pour que √ßa disparaisse tout de suite)
            let localFinished = JSON.parse(localStorage.getItem('finished_orders') || '[]');
            if(!localFinished.includes(id)) {
                localFinished.push(id);
                localStorage.setItem('finished_orders', JSON.stringify(localFinished));
            }

            // 2. Envoi √† Google Sheets (Silent update)
            fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ action: 'serve', orderId: id })
            });

            // 3. Animation de sortie
            const card = btnElement.closest('.order-card');
            card.style.transition = "all 0.5s ease";
            card.style.opacity = "0";
            card.style.transform = "translateX(100px)";
            
            setTimeout(() => {
                card.remove();
                // V√©rifier si c'√©tait le dernier
                const container = document.getElementById('orders-list');
                if(container.children.length === 0) {
                     container.innerHTML = '<p style="text-align:center; margin-top:50px; color:#888; font-size:1.2em;"><i class="fas fa-mug-hot"></i><br>Tout est servi !</p>';
                }
            }, 500);
        }

        let timeLeft = 15;
        function startTimer() {
            setInterval(() => {
                timeLeft--;
                const timerSpan = document.getElementById('timer');
                if(timerSpan) timerSpan.innerText = `(${timeLeft}s)`;
                if(timeLeft <= 0) timeLeft = 15;
            }, 1000);
        }

        // --- PARSEUR CSV ROBUSTE ---
        function parseCSV(str) {
            const lines = str.split('\n').filter(l => l.trim() !== '');
            if (lines.length < 2) return [];
            const headers = lines[0].split(',').map(h => h.trim());
            
            return lines.slice(1).map(line => {
                const values = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                const cleanValues = values.map(val => val.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
                let obj = {};
                headers.forEach((h, i) => obj[h] = cleanValues[i] || '');
                return obj;
            });
        }
    </script>
    
    <style>
        @keyframes slideIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>
